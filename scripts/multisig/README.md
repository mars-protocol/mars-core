# Multisig

## Dependencies

- Go
- terrad

### Install Go

Follow instructions at https://golang.org/dl/

### Install terrad

Run the following commands in a terminal:

```sh
git clone https://github.com/terra-money/core.git
cd core
git checkout v0.5.6
rm $(which terrad) # delete any currently installed versions
make install
```

Test that the installation was successful by running:

```sh
terrad version # should print `0.5.6`
```

# Instructions for multisig key holders

As a multisig key holder, you will be required to sign transactions.
The instructions below explain how to do this.

## Setup your key in terrad

- Setup a new private key

```sh
terrad keys add <name>
```

- Or recover an existing private key

```sh
terrad keys add <name> --recover
# Then enter your 24 word mnemonic
```

- Or use a private key on a Ledger hardware device

```sh
terrad keys add <name> \
  --ledger \
  --account <account> # The 0th account is used by Terra Station
```

- Check the key was added and export the public key (`pubkey` JSON object)

```sh
terrad keys show <name>
```

For example, the public key of the account `test1` is `'{"@type":"/cosmos.crypto.secp256k1.PubKey","key":"AjszqFJDRAYbEjZMuiD+ChqzbUSGq/RRu3zr0R6iJB5b"}'`:

```console
‚ùØ terrad keys show test1
- name: test1
  type: local
  address: terra1x46rqay4d3cssq8gxxvqz8xt6nwlz4td20k38v
  pubkey: '{"@type":"/cosmos.crypto.secp256k1.PubKey","key":"AjszqFJDRAYbEjZMuiD+ChqzbUSGq/RRu3zr0R6iJB5b"}'
  mnemonic: ""
```

## Add the multisig as an account in terrad

You will be provided with a set of commands that adds the following as accounts in terrad:
1. Each of `n` keys to the multisig
2. The multisig

## Create a signature for a transaction

You will be sent:
- An unsigned transaction JSON file
- Signing instructions

You need to:
- Open a terminal
- Change directory to the location of the unsigned transaction JSON file

```sh
cd path/to/directory
```

- Inspect the messages to be executed in the unsigned transaction.

:warning: **Do not sign transactions blindly** :warning:

```sh
# For messages executed on a contract:
jq ".body.messages[0].execute_msg" unsigned.json

# For messages executed via proxy contracts:
jq ".body.messages[0].execute_msg.execute.msgs[0].wasm.execute.msg" unsigned.json \
  | tr -d '\"' \
  | base64 -d
```

- Follow the signing instructions that were sent to you.

Enter your computer's login password if prompted to do so. You may be prompted multiple times.

- Return the signature file that is generated by running the command

# Instructions for creators of multisig transactions

As a multisig transaction creator, you will be required to create unsigned transactions.
The instructions below explain how to do this.

## Create a multisig in terrad

- Collect public keys of private keys that will be signers on the multisig.
Ask key holders to send the `pubkey` field from the output of the following command:

```sh
terrad keys show <name>
```

- Add the public keys to terrad:

```sh
terrad keys add <name> --pubkey '{"@type":"<type>","key":"<key>"}'
```

- Create a multisig from the public keys:

```sh
terrad keys add <multisig_name> \
  --multisig <name_1>,<name_2>[,<name_3>...] \
  --multisig-threshold <k>
```

- Before the multisig can be used, it must be created on chain by sending some funds to its address.
These funds can then be used to pay transaction fees.

## Create an unsigned transaction

- Populate a `.env` file with the required environment variables from `create_unsigned_tx.ts`
- Create an unsigned transaction:

```sh
node --loader ts-node/esm create_unsigned_tx.ts
```

- Distribute the following to multisig key holders:
  - Unsigned transaction JSON file
  - The instructions that were printed to stdout by `create_unsigned_tx.ts`

## Broadcast a transaction

- Collect signatures from multisig key holders
- Populate a `.env` file with the required environment variables from `broadcast_tx.ts`
- Sign the transaction and broadcast it to the network:

```sh
node --loader ts-node/esm broadcast_tx.ts
```
